<!DOCTYPE html>
<html>
<head>
    <title>Attendance Marking</title>
    <script>
        // Function to get the query parameter from the URL
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Function to get the user's geolocation
        function fetchGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            resolve({ latitude, longitude });
                        },
                        (error) => {
                            reject(error.message);
                        }
                    );
                } else {
                    reject("Geolocation not supported by this browser.");
                }
            });
        }

        // Function to fetch private IP using WebRTC
        function getPrivateIP() {
            return new Promise((resolve, reject) => {
                const peerConnection = new RTCPeerConnection();
                peerConnection.createDataChannel(""); // Create a dummy data channel
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .catch(error => reject(error));

                peerConnection.onicecandidate = (event) => {
                    if (event && event.candidate) {
                        const candidate = event.candidate.candidate;
                        const ipRegex = /(?:\d{1,3}\.){3}\d{1,3}/;
                        const ip = ipRegex.exec(candidate);
                        if (ip) {
                            resolve(ip[0]);
                            peerConnection.close();
                        }
                    }
                };
            });
        }

        // Function to fetch public IP using a public API
        function getPublicIP() {
            return fetch("https://api.ipify.org?format=json")
                .then(response => response.json())
                .then(data => data.ip)
                .catch(() => "Unable to fetch public IP");
        }

        // Main function to handle attendance marking
        async function initializeAttendance() {
            const studentId = getUrlParameter("student_id");
            const studentIdDisplay = document.getElementById("studentId");
            const locationDisplay = document.getElementById("location");
            const publicIpDisplay = document.getElementById("publicIpAddress");
            const privateIpDisplay = document.getElementById("privateIpAddress");

            if (studentId) {
                studentIdDisplay.innerText = "Student ID: " + decodeURIComponent(studentId);

                // Fetch geolocation
                try {
                    const location = await fetchGeolocation();
                    const { latitude, longitude } = location;
                    locationDisplay.innerText = `Location: Latitude ${latitude}, Longitude ${longitude}`;
                } catch (error) {
                    locationDisplay.innerText = "Location: Unable to fetch location (" + error + ")";
                }

                // Fetch public IP
                getPublicIP()
                    .then(ip => {
                        publicIpDisplay.innerText = "Public IP Address: " + ip;
                    })
                    .catch(error => {
                        publicIpDisplay.innerText = "Public IP Address: Unable to fetch (" + error + ")";
                    });

                // Fetch private IP
                try {
                    const privateIp = await getPrivateIP();
                    privateIpDisplay.innerText = "Private IP Address: " + privateIp;
                } catch (error) {
                    privateIpDisplay.innerText = "Private IP Address: Unable to fetch (" + error + ")";
                }
            } else {
                studentIdDisplay.innerText = "No student ID found!";
            }
        }

        // Initialize attendance marking on page load
        window.onload = initializeAttendance;
    </script>
</head>
<body>
    <h1>Attendance Marking</h1>
    <p id="studentId">Fetching your details...</p>
    <p id="location">Fetching your location...</p>
    <p id="publicIpAddress">Fetching your public IP address...</p>
    <p id="privateIpAddress">Fetching your private IP address...</p>
</body>
</html>
